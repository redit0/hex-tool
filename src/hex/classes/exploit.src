Exploit = {
    "classID": "Exploit",
    "metaLib": null,
    "address": null,
    "value": null,
    "requirements": {},
    "result": {
        "obj": null,
        "type": null,
        "user": null
    }
}

// Executes a buffer overflow using the Exploit's metaLib, address, and value.
// An optional extra parameter is forwarded to the overflow call (e.g. a target device IP).
// Stores the result object, its type, and the resolved user on self.result.
// @param {string} extra - Optional extra argument passed to metaLib.overflow (e.g. a device IP or new password).
// @return {Result} - A Result object; on success, data contains the overflowed object.
Exploit.Overflow = function(extra = null)
    if extra != null then
        result = self.metaLib.overflow(self.address, self.value, extra)
    else
        result = self.metaLib.overflow(self.address, self.value)
    end if

    if result isa string then
        print g.error(result)
        return Result.New(0, null, result)
    end if

    if result == null then
        return Result.New(0, null, "Overflow failed.")
    end if

    self.result.obj = result
    self.result.type = typeof(result)
    self.result.user = self.GetUser(result)

    return Result.New(1, result, "Success! Found " + self.GetOutput(self.result.obj))
end function

// Builds a human-readable, color-coded string describing the overflow result stored in
// self.result, including the object type and the resolved user permission level.
// @return {string} - A formatted description of the overflow result.
Exploit.GetOutput = function
    if self.result.type == "shell" then
        output = "[" + g.r1("shell") + "] with permissions from "
    else if self.result.type == "computer" then
        output = "[" + g.o1("computer") + "] with permissions from "
    else if self.result.type == "file" then
        output = "[" + g.g1("file") + "] with permissions from "
    else if self.result.type == null then
        return "Overflow failed."
    else
        output = g.l1(self.result.type)
    end if

    if ["shell", "computer", "file"].contains(self.result.type) then
        if self.result.user == "root" then
            output = output + "user: " + g.r1("root")
        else if self.result.user == "guest" then
            output = output + "user: " + g.l3("guest")
        else if self.result.user == null then
            output = output + "user: " + g.d1("unknown")
        else
            output = output + g.o1("non-root user")
        end if
    end if

    return output
end function

// Determines the effective user of a shell, computer, or file object returned by an
// overflow by inspecting filesystem permissions from the root.  Returns "root" if the
// root folder is writable, a username if a writable home directory is found, "unknown"
// if all home directories are locked down, or "guest" otherwise.
// @param {shell|computer|file|number|null} obj - The object whose permissions are inspected.
// @return {string|null} - The resolved username, or null if obj is null.
Exploit.GetUser = function(obj)
    if typeof(obj) == "shell" then
        file = obj.host_computer.File("/")
    else if typeof(obj) == "computer" then
        file = obj.File("/")
    else if typeof(obj) == "file" then
        file = obj
    else if obj == null then
        return null
    else
        return "unknown"
    end if

    while file.path != "/"
        file = file.parent
    end while

    if file.has_permission("w") then
        return "root"
    end if

    secured = 1

    for folder in file.get_folders
        if folder.name == "home" then
            for userDir in folder.get_folders
                if userDir.permissions[-9:] != "---------" then secured = 0
                if userDir.has_permission("w") and userDir.name != "guest" then
                    return userDir.name
                end if
            end for
        end if
    end for

    if secured then
        return "unknown"
    else
        return "guest"
    end if
end function

// Creates a new Exploit object configured with the given metaLib, memory address, and value.
// @param {metaLib} metaLib - The metaxploit library object used to perform the overflow.
// @param {string} address - The memory address to target (e.g. "0x32E65B93").
// @param {string} value - The overflow value to inject at the target address.
// @return {Exploit} - A new Exploit instance ready to call Overflow.
Exploit.New = function(metaLib, address, value)
    result = new self

    result.metaLib = metaLib
    result.address = address
    result.value = value

    return result
end function